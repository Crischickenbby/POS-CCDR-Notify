{% extends 'punto_venta.html' %}

{% block title %}Clientes{% endblock %}

{% block styles %}

{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-10">
	<div id="contenedorPrincipal" class="bg-white rounded-3xl shadow-2xl p-8 border border-gray-100">
		{% if mensaje_envio %}
			<div class="mb-6">
				<div id="flash-messages" class="px-4 py-3 rounded-xl text-white font-semibold shadow-lg
					{% if 'correctamente' in mensaje_envio %}bg-green-600{% else %}bg-red-600{% endif %}">
					{{ mensaje_envio }}
				</div>
				<script>
				  setTimeout(function() {
					var flash = document.getElementById('flash-messages');
					if (flash) flash.style.display = 'none';
				  }, 3000);
				</script>
			</div>
		{% endif %}
		<!-- Overlay de bloqueo -->
		<div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
			<div class="bg-white rounded-xl p-8 shadow-2xl text-center">
				<div class="mb-4">
					<svg class="animate-spin h-12 w-12 mx-auto text-ccdr-red" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
						<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
						<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
					</svg>
				</div>
				<p class="text-lg font-semibold text-gray-800">Enviando correos...</p>
				<p class="text-sm text-gray-600 mt-2">Por favor espera, esto puede tomar unos momentos</p>
			</div>
		</div>

		<h1 class="text-4xl font-extrabold text-ccdr-red mb-6 tracking-wide drop-shadow-md flex items-center gap-3">
			<i class='bx bx-envelope text-5xl text-ccdr-red'></i>
			Gestión de Correos a Clientes
		</h1>
		{% set filtro = request.form.get('filtro', '') %}
		<div class="flex flex-col sm:flex-row gap-4 mb-6">
			<form method="POST" class="flex-1">
				<input type="hidden" name="filtro" value="mas_compran">
				<button type="submit" class="w-full py-3 rounded-xl font-semibold shadow transition-all duration-200 
					{% if filtro == 'mas_compran' %}bg-green-700 text-white scale-105{% else %}bg-green-100 text-green-900 hover:bg-green-200{% endif %}">
					<i class='bx bx-up-arrow-circle mr-2'></i> Clientes que más compran
				</button>
			</form>
			<form method="POST" class="flex-1">
				<input type="hidden" name="filtro" value="menos_compran">
				<button type="submit" class="w-full py-3 rounded-xl font-semibold shadow transition-all duration-200 
					{% if filtro == 'menos_compran' %}bg-yellow-600 text-white scale-105{% else %}bg-yellow-100 text-yellow-900 hover:bg-yellow-200{% endif %}">
					<i class='bx bx-down-arrow-circle mr-2'></i> Clientes que menos compran
				</button>
			</form>
		</div>
		<form method="POST" class="flex flex-col sm:flex-row items-center gap-3 mb-8" autocomplete="off">
			<input id="busquedaCliente" name="busqueda" type="text" placeholder="Buscar cliente por nombre, apellido o correo..." class="border-2 border-ccdr-red rounded-xl px-4 py-3 w-full focus:outline-none focus:ring-2 focus:ring-ccdr-red" value="{% if filtro %}{% else %}{{ request.form.get('busqueda', '') }}{% endif %}">
			<button type="submit" class="px-6 py-3 bg-ccdr-red text-white rounded-xl font-bold shadow hover:bg-ccdr-red-dark transition-all duration-200">Buscar</button>
		</form>
		<div id="listaClientes" class="mt-4">
			{% if clientes and clientes|length > 0 %}
				<div class="flex justify-end mb-2">
					<button type="button" id="toggleSelectAll" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-semibold shadow hover:bg-blue-700 transition-all duration-200">
						Seleccionar/Deseleccionar todos
					</button>
				</div>
				<form id="formSeleccionClientes" method="POST">
					<input type="hidden" name="filtro" value="{{ filtro }}">
					<div class="divide-y divide-gray-200 bg-gray-50 rounded-xl shadow-inner">
						{% for cliente in clientes %}
							<div class="flex flex-col sm:flex-row sm:items-center justify-between py-4 px-4 hover:bg-gray-100 transition-all">
								<div class="flex items-center gap-3">
									<input type="checkbox" class="cliente-checkbox h-5 w-5 text-ccdr-red focus:ring-ccdr-red" name="clientes_seleccionados" value="{{ cliente[0] }}">
									<div class="flex flex-col sm:flex-row sm:items-center gap-2">
										<span class="font-semibold text-lg text-gray-800">{{ cliente[1] }} {{ cliente[2] }}</span>
										<span class="text-gray-500">- {{ cliente[3] }}</span>
										{% if cliente|length > 4 %}
											<span class="ml-2 text-sm text-gray-500">Compras: <span class="font-bold text-ccdr-red">{{ cliente[4] }}</span></span>
										{% endif %}
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
					<div class="flex justify-end mt-6">
						<button type="submit" name="accion" value="enviar_correos" class="px-6 py-3 bg-ccdr-red text-white rounded-xl font-bold shadow hover:bg-ccdr-red-dark transition-all duration-200 flex items-center gap-2">
							<i class='bx bx-mail-send text-xl'></i> Enviar correo a seleccionados
						</button>
					</div>
				</form>
				<script>
					// Script para seleccionar/deseleccionar todos los checkboxes
					document.addEventListener('DOMContentLoaded', function() {
						const toggleBtn = document.getElementById('toggleSelectAll');
						const checkboxes = document.querySelectorAll('.cliente-checkbox');
						let allSelected = false;
						toggleBtn.addEventListener('click', function() {
							allSelected = !allSelected;
							checkboxes.forEach(cb => { cb.checked = allSelected; });
						});

						// Bloquear módulo al enviar correos
						const formSeleccionar = document.getElementById('formSeleccionClientes');
						formSeleccionar.addEventListener('submit', function(e) {
							document.getElementById('loadingOverlay').classList.remove('hidden');
							document.getElementById('contenedorPrincipal').style.opacity = '0.5';
							document.getElementById('contenedorPrincipal').style.pointerEvents = 'none';
						});
					});
				</script>
			{% else %}
				<div class="text-center text-gray-400 py-8 text-lg">No hay clientes registrados.</div>
			{% endif %}
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}

{% endblock %}